@page
@model SwiftStock.Pages.Admin.Users.DetailsModel
@using SwiftStock.Models
@{
    ViewData["Title"] = $"Détails - {Model.UserModel?.FirstName} {Model.UserModel?.LastName}";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-user"></i> Détails de l'utilisateur</h2>
                <div>
                    <a asp-page="Edit" asp-route-id="@Model.UserModel?.Id" class="btn btn-warning">
                        <i class="fas fa-edit"></i> Modifier
                    </a>
                    <a asp-page="Index" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Retour à la liste
                    </a>
                </div>
            </div>

            @if (Model.UserModel != null)
            {
                <div class="row">
                    <div class="col-lg-4">
                        <!-- Informations personnelles -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Informations personnelles</h5>
                            </div>
                            <div class="card-body text-center">
                                <div class="avatar-lg bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3">
                                    @Model.UserModel.FirstName.Substring(0, 1).ToUpper()@Model.UserModel.LastName.Substring(0, 1).ToUpper()
                                </div>
                                <h4>@Model.UserModel.FirstName @Model.UserModel.LastName</h4>
                                <p class="text-muted">@Model.UserModel.Email</p>
                                
                                <div class="mb-3">
                                    <span class="badge bg-@(Model.UserModel.Role switch {
                                        "Admin" => "danger",
                                        "Manager" => "warning", 
                                        "Cashier" => "info",
                                        "StockManager" => "success",
                                        _ => "secondary"
                                    }) fs-6">
                                        @Model.UserModel.Role
                                    </span>
                                </div>

                                <div class="mb-3">
                                    @if (Model.UserModel.IsActive)
                                    {
                                        <span class="badge bg-success fs-6">Actif</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger fs-6">Inactif</span>
                                    }
                                </div>

                                @if (Model.UserModel.MustChangePassword)
                                {
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        L'utilisateur doit changer son mot de passe
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Statistiques -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Statistiques</h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <h4 class="text-primary">@Model.TotalSales</h4>
                                        <small class="text-muted">Ventes</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-success">@Model.TotalAmount.ToString("N0") F</h4>
                                        <small class="text-muted">Chiffre d'affaires</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <!-- Informations détaillées -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Informations détaillées</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Téléphone</label>
                                            <p class="form-control-plaintext">@(Model.UserModel.PhoneNumber ?? "Non renseigné")</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Emplacement par défaut</label>
                                            <p class="form-control-plaintext">@(Model.UserModel.DefaultLocation?.Name ?? "Aucun")</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Adresse</label>
                                    <p class="form-control-plaintext">@(Model.UserModel.Address ?? "Non renseignée")</p>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Ville</label>
                                            <p class="form-control-plaintext">@(Model.UserModel.City ?? "Non renseignée")</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Pays</label>
                                            <p class="form-control-plaintext">@(Model.UserModel.Country ?? "Non renseigné")</p>
                                        </div>
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(Model.UserModel.Notes))
                                {
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Notes</label>
                                        <p class="form-control-plaintext">@Model.UserModel.Notes</p>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Informations système -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Informations système</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Date de création</label>
                                            <p class="form-control-plaintext">@Model.UserModel.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Dernière connexion</label>
                                            <p class="form-control-plaintext">
                                                @if (Model.UserModel.LastLoginAt.HasValue)
                                                {
                                                    @Model.UserModel.LastLoginAt.Value.ToString("dd/MM/yyyy HH:mm")
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Jamais</span>
                                                }
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                @if (Model.UserModel.LastPasswordChange.HasValue)
                                {
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Dernier changement de mot de passe</label>
                                        <p class="form-control-plaintext">@Model.UserModel.LastPasswordChange.Value.ToString("dd/MM/yyyy HH:mm")</p>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Historique des ventes récentes -->
                        @if (Model.RecentSales.Any())
                        {
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Ventes récentes</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>N° Vente</th>
                                                    <th>Montant</th>
                                                    <th>Statut</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var sale in Model.RecentSales)
                                                {
                                                    <tr>
                                                        <td>@sale.SaleDate.ToString("dd/MM/yyyy")</td>
                                                        <td>@sale.SaleNumber</td>
                                                        <td>@sale.TotalAmount.ToString("N0") F</td>
                                                        <td>
                                                            <span class="badge bg-@(sale.Status switch {
                                                                Models.SaleStatus.Completed => "success",
                                                                Models.SaleStatus.Cancelled => "danger",
                                                                Models.SaleStatus.Refunded => "warning",
                                                                _ => "secondary"
                                                            })">
                                                                @sale.Status
                                                            </span>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    @if (Model.TotalSales > 5)
                                    {
                                        <div class="text-center">
                                            <a href="/Sales?userId=@Model.UserModel.Id" class="btn btn-outline-primary btn-sm">
                                                Voir toutes les ventes
                                            </a>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Utilisateur non trouvé.
                </div>
            }
        </div>
    </div>
</div>

<style>
    .avatar-lg {
        width: 80px;
        height: 80px;
        font-size: 24px;
    }
</style>
